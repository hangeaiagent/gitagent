# çœŸå®éƒ¨ç½²æµç¨‹å®Œæ•´åˆ†æ - 070902

## ğŸš€ çœŸå®éƒ¨ç½²æŒ‰é’®ç‚¹å‡»å®Œæ•´æµç¨‹åˆ†æ

### 1. å‰ç«¯è§¦å‘æµç¨‹

#### 1.1 ç”¨æˆ·æ“ä½œ
- **è§¦å‘ä½ç½®**: `src/App.tsx` ç¬¬ 325 è¡Œ
- **è§¦å‘å‡½æ•°**: `handleRealDeploy()`
- **æ—¥å¿—æ ‡è¯†**: `[070902]`

```typescript
const handleRealDeploy = async () => {
  // éªŒè¯å¿…è¦é…ç½®
  if (!githubUrl || !serverConfig.host || !serverConfig.username || !serverConfig.sshKey) {
    alert('è¯·å¡«å†™æ‰€æœ‰å¿…è¦ä¿¡æ¯');
    return;
  }

  if (!claudeApiKey) {
    alert('è¯·å…ˆé…ç½®Claude API Key');
    return;
  }

  const config: DeploymentConfig = {
    githubUrl,
    serverConfig,
    claudeApiKey,
  };

  // ä½¿ç”¨çœŸå®æ‰§è¡Œå¼•æ“
  await startRealDeployment(config);
};
```

#### 1.2 Hook è°ƒç”¨
- **æ–‡ä»¶**: `src/hooks/useDeployment.ts`
- **å‡½æ•°**: `startRealDeployment()`
- **è¡Œå·**: ç¬¬ 171 è¡Œ

### 2. éƒ¨ç½²æœåŠ¡åˆå§‹åŒ–

#### 2.1 EnhancedDeploymentService åˆ›å»º
- **æ–‡ä»¶**: `src/services/enhancedDeploymentService.ts`
- **å‡½æ•°**: `executeRealDeployment()`
- **è¡Œå·**: ç¬¬ 20 è¡Œ

```typescript
const enhancedService = new EnhancedDeploymentService(config.claudeApiKey);

addLog({
  id: Date.now().toString(),
  timestamp: new Date(),
  level: 'info',
  message: '[070902] ğŸš€ å¯åŠ¨çœŸå®éƒ¨ç½²æµç¨‹',
  details: `ç›®æ ‡: ${config.githubUrl}`,
});
```

#### 2.2 æ™ºèƒ½ä½“åˆå§‹åŒ–
- **æ™ºèƒ½ä½“ç±»å‹**:
  - ConnectionAgent: SSHè¿æ¥ç®¡ç†
  - ExecutionAgent: å‘½ä»¤æ‰§è¡Œ
  - ValidationAgent: éªŒè¯æ£€æŸ¥
  - DeploymentManager: éƒ¨ç½²ç®¡ç†

### 3. SSHé…ç½®å‡†å¤‡

#### 3.1 SSHé…ç½®å¤„ç†
- **æ–‡ä»¶**: `src/services/enhancedDeploymentService.ts`
- **å‡½æ•°**: `prepareSshConfig()`
- **è¡Œå·**: ç¬¬ 121 è¡Œ

```typescript
onLog({
  id: Date.now().toString(),
  timestamp: new Date(),
  level: 'info',
  message: '[070902] ğŸ” å‡†å¤‡SSHè¿æ¥é…ç½®',
  agentName: 'SSHConfigurer'
});
```

### 4. è¿­ä»£éƒ¨ç½²æ§åˆ¶å™¨å¯åŠ¨

#### 4.1 æ§åˆ¶å™¨åˆå§‹åŒ–
- **æ–‡ä»¶**: `src/services/iterativeDeploymentController.ts`
- **å‡½æ•°**: `startDeployment()`
- **è¡Œå·**: ç¬¬ 32 è¡Œ

```typescript
this.onLog({
  id: Date.now().toString(),
  timestamp: new Date(),
  level: 'info',
  message: '[070902] ğŸš€ å¯åŠ¨è¿­ä»£éƒ¨ç½²æµç¨‹',
  details: `ç›®æ ‡: ${config.githubUrl}`,
  agentName: 'DeploymentController'
});
```

### 5. ç³»ç»Ÿå¥åº·æ£€æŸ¥ (é—®é¢˜å‘ç”Ÿç‚¹)

#### 5.1 å¥åº·æ£€æŸ¥å¯åŠ¨
- **æ–‡ä»¶**: `src/services/iterativeDeploymentController.ts`
- **å‡½æ•°**: `performSystemHealthCheck()`
- **è¡Œå·**: ç¬¬ 76 è¡Œ

```typescript
this.onLog({
  id: Date.now().toString(),
  timestamp: new Date(),
  level: 'info',
  message: '[070902] ğŸ” æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥',
  agentName: 'HealthChecker'
});
```

#### 5.2 SSHè¿æ¥æ€§æ£€æŸ¥
- **æ–‡ä»¶**: `src/services/realExecutionEngine.ts`
- **å‡½æ•°**: `healthCheck()`
- **è¡Œå·**: ç¬¬ 478 è¡Œ

```typescript
async healthCheck(): Promise<boolean> {
  this.onLog({
    id: Date.now().toString(),
    timestamp: new Date(),
    level: 'info',
    message: '[070902] ğŸ¥ å¼€å§‹ç³»ç»Ÿå¥åº·æ£€æŸ¥',
    details: `ç›®æ ‡ä¸»æœº: ${this.sshConfig.host}:${this.sshConfig.port}`,
    agentName: 'HealthChecker'
  });

  try {
    const result = await this.executeCommand('echo "health check"', { timeout: 5000 });
    return result.success;
  } catch (error) {
    return false;
  }
}
```

### 6. SSHå‘½ä»¤æ‰§è¡Œ (é”™è¯¯å‘ç”Ÿç‚¹)

#### 6.1 å‘½ä»¤æ‰§è¡Œè°ƒç”¨
- **æ–‡ä»¶**: `src/services/realExecutionEngine.ts`
- **å‡½æ•°**: `executeCommand()`
- **è¡Œå·**: ç¬¬ 44 è¡Œ

```typescript
async executeCommand(
  command: string, 
  options: ExecutionOptions = {}
): Promise<CommandResult> {
  // ... æ‰§è¡Œé€»è¾‘
  const result = await this.executeSSHCommand(command, options);
  // ...
}
```

#### 6.2 SSH APIè°ƒç”¨ (é—®é¢˜æ ¸å¿ƒ)
- **æ–‡ä»¶**: `src/services/realExecutionEngine.ts`
- **å‡½æ•°**: `executeSSHCommand()`
- **è¡Œå·**: ç¬¬ 190 è¡Œ

```typescript
// é€šè¿‡SSHä»£ç†æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤
const response = await fetch('/api/ssh/execute', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    config: {
      host: this.sshConfig.host,
      port: this.sshConfig.port,
      username: this.sshConfig.username,
      sshKey: this.sshConfig.privateKey,
      keyPath: this.sshConfig.keyPath
    },
    command: remoteCommand,
    timeout
  }),
  signal: AbortSignal.timeout(timeout)
});
```

### 7. é”™è¯¯åˆ†æ

#### 7.1 å½“å‰é”™è¯¯çŠ¶å†µ
```
POST http://44.203.197.203/api/ssh/execute net::ERR_CONNECTION_RESET
```

#### 7.2 é”™è¯¯åŸå› åˆ†æ
1. **Nginxé…ç½®é—®é¢˜**: `/api/ssh/execute` è·¯ç”±æœªæ­£ç¡®é…ç½®
2. **åç«¯æœåŠ¡æœªå¯åŠ¨**: SSHä»£ç†æœåŠ¡å™¨å¯èƒ½æœªè¿è¡Œ
3. **é˜²ç«å¢™é˜»æ­¢**: ç«¯å£3000å¯èƒ½è¢«é˜²ç«å¢™é˜»æ­¢
4. **SSL/TLSé—®é¢˜**: HTTPS/HTTPæ··åˆå†…å®¹é—®é¢˜

#### 7.3 æ—¥å¿—è¾“å‡ºå¢å¼º
ç°åœ¨æ‰€æœ‰æ—¥å¿—éƒ½åŒ…å« `[070902]` æ ‡è¯†ç¬¦ï¼Œä¾¿äºè¿½è¸ªï¼š

```typescript
// SSHæ‰§è¡Œæ—¥å¿—
logSSHExecution(command, result, host, username) {
  const message = result.success 
    ? `[070902] âœ… SSHå‘½ä»¤æ‰§è¡ŒæˆåŠŸ: ${command}`
    : `[070902] âŒ SSHå‘½ä»¤æ‰§è¡Œå¤±è´¥: ${command}`;
  // ...
}

// è¿æ¥æ—¥å¿—
logConnection(type, host, username, port, details) {
  const messageMap = {
    connect: `[070902] ğŸ”— SSHè¿æ¥æˆåŠŸ: ${username}@${host}:${port}`,
    disconnect: `[070902] ğŸ”Œ SSHè¿æ¥æ–­å¼€: ${username}@${host}:${port}`,
    error: `[070902] ğŸ’¥ SSHè¿æ¥å¤±è´¥: ${username}@${host}:${port}`
  };
  // ...
}
```

### 8. è§£å†³æ–¹æ¡ˆ

#### 8.1 ç«‹å³æ£€æŸ¥é¡¹ç›®
1. **æ£€æŸ¥Nginxé…ç½®**: ç¡®ä¿ `/api/ssh/execute` è·¯ç”±æ­£ç¡®ä»£ç†åˆ°åç«¯
2. **æ£€æŸ¥åç«¯æœåŠ¡**: ç¡®è®¤SSHä»£ç†æœåŠ¡å™¨åœ¨ç«¯å£3000è¿è¡Œ
3. **æ£€æŸ¥ç½‘ç»œè¿æ¥**: éªŒè¯ä»å‰ç«¯åˆ°åç«¯çš„ç½‘ç»œè¿é€šæ€§

#### 8.2 è°ƒè¯•æ­¥éª¤
1. **æŸ¥çœ‹Nginxæ—¥å¿—**: `sudo journalctl -u nginx -f`
2. **æ£€æŸ¥ç«¯å£å ç”¨**: `sudo netstat -tlnp | grep :3000`
3. **æµ‹è¯•APIç«¯ç‚¹**: `curl -X POST http://44.203.197.203/api/ssh/execute`

#### 8.3 é…ç½®ä¿®å¤
ç¡®ä¿Nginxé…ç½®åŒ…å«ï¼š
```nginx
location /api/ {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

### 9. å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"çœŸå®éƒ¨ç½²" 
    â†“
handleRealDeploy() [App.tsx]
    â†“
startRealDeployment() [useDeployment.ts]
    â†“
EnhancedDeploymentService.executeRealDeployment()
    â†“
prepareSshConfig() [SSHé…ç½®å‡†å¤‡]
    â†“
IterativeDeploymentController.startDeployment()
    â†“
performSystemHealthCheck() [ç³»ç»Ÿå¥åº·æ£€æŸ¥]
    â†“
RealExecutionEngine.healthCheck()
    â†“
executeCommand('echo "health check"')
    â†“
executeSSHCommand() [SSHå‘½ä»¤æ‰§è¡Œ]
    â†“
fetch('/api/ssh/execute') [APIè°ƒç”¨]
    â†“
âŒ net::ERR_CONNECTION_RESET [é”™è¯¯å‘ç”Ÿç‚¹]
```

### 10. ç›‘æ§å’Œæ—¥å¿—

æ‰€æœ‰å…³é”®æ­¥éª¤ç°åœ¨éƒ½åŒ…å« `[070902]` æ ‡è¯†ç¬¦ï¼š
- ğŸš€ éƒ¨ç½²æµç¨‹å¯åŠ¨
- ğŸ” SSHé…ç½®å‡†å¤‡  
- ğŸ” ç³»ç»Ÿå¥åº·æ£€æŸ¥
- ğŸŒ SSHè¿æ¥æ€§æ£€æŸ¥
- ğŸ”§ SSHå‘½ä»¤æ‰§è¡Œ
- ğŸ“¡ APIå“åº”çŠ¶æ€
- âœ…/âŒ æ‰§è¡Œç»“æœ

è¿™æ ·å¯ä»¥æ›´å®¹æ˜“åœ°åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿‡æ»¤å’Œè¿½è¸ªç›¸å…³æ—¥å¿—ã€‚ 